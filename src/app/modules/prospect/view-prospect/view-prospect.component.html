<div class="w-100 d-flex justify-content-between">
  <div
    *ngIf="(authService.currentUser$ | async).group !== permissions.ViewOnly"
    class="p-2 d-flex justify-content-end"
  >
    <button
      (click)="exportListToExcel()"
      [disabled]="checkedIds.length < 1"
      nz-button
      nzType="primary"
    >
      Export Selected
    </button>
  </div>

  <div
    *ngIf="(authService.currentUser$ | async).group !== permissions.ViewOnly"
    nz-row
  >
    <div
      *ngIf="(authService.currentUser$ | async).reel_eval_admin && !achievedTable"
      class="p-2 d-flex justify-content-end"
    >
      <nz-upload [nzAccept]="['.xlsx', '.xls']" [nzBeforeUpload]="beforeUpload">
        <button class="d-flex" nz-button nzType="primary">
          <span nz-icon nzType="upload"></span>
          Upload Prospect List
        </button>
      </nz-upload>
    </div>

    <div class="p-2 d-flex justify-content-end">
      <button
        (click)="exportCompleteListToExcel()"
        [disabled]="checkedIds.length >= 1"
        nz-button
        nzType="primary"
      >
        Export List
      </button>
    </div>
    <div
      *ngIf="
        !achievedTable &&
        (authService.currentUser$ | async).group !== permissions.ViewOnly &&
        (authService.currentUser$ | async).group !== permissions.GradeProspects
      "
      class="p-2 d-flex justify-content-end"
    >
      <button (click)="addProspect()" nz-button nzType="primary">
        Add Prospect
      </button>
    </div>
  </div>
</div>

<div class="m-2 box-shadow">
  <nz-table
    #borderedTable
    (nzCurrentPageDataChange)="onCurrentPageDataChange($event)"
    (nzQueryParams)="onQueryParamsChange($event)"
    [nzData]="dataSet"
    [nzFrontPagination]="false"
    [nzPageIndex]="pageIndex"
    [nzPageSizeOptions]="[10, 20, 30, 40, 50]"
    [nzPageSize]="pageSize"
    [nzScroll]="{ x: '1100px', y: '400px' }"
    [nzTotal]="total"
    class="w-100"
    nzBordered
    nzShowSizeChanger
    nzSize="small"
    [nzLoading]="loadingService.loading | async"
    nzTableLayout="fixed"
  >
    <thead>
    <tr class="align-content-center">
      <th
        (nzCheckedChange)="onAllChecked($event)"
        *ngIf="
            (authService.currentUser$ | async).group !== permissions.ViewOnly
          "
        [(nzChecked)]="checked"
        [nzIndeterminate]="indeterminate"
        nzEllipsis
        nzWidth="80px"
      ></th>
      <th
        *ngFor="let column of listOfColumns; let i = index"
        [nz-tooltip]="column.tooltipText"
        [nzColumnKey]="listOfSort[i]"
        [nzCustomFilter]="column.name !== 'Video url'"
        [nzLeft]="column.name === 'First Name'"
        [nzSortFn]="true"
        [nzWidth]="column.width"
        class="text-align-left"
        nzEllipsis
      >
        {{ column.name }}

        <nz-filter-trigger
          *ngIf="column.name !== 'Video url'"
          [(nzVisible)]="visible[listOfFilter?.[i]]"
          [nzActive]="searchValue[listOfFilter[i]]?.length > 0"
          [nzDropdownMenu]="menu"
        >
          <span nz-icon nzType="search"></span>
        </nz-filter-trigger>
        <nz-dropdown-menu #menu="nzDropdownMenu">
          <div class="ant-table-filter-dropdown">
            <div class="search-box">
              <input
                *ngIf="
                    column.name !== 'Positions' &&
                    column.name !== 'State/Province' &&
                    column.name !== 'School/Team'
                  "
                [(ngModel)]="searchValue[listOfFilter[i]]"
                [placeholder]="'Search ' + column.name"
                nz-input
                type="text"
              />
              <app-position-multi-select
                *ngIf="column.name === 'Positions'"
                [formControl]="positionSearchFormControl"
              ></app-position-multi-select>

              <app-states-select-search
                *ngIf="column.name === 'State/Province'"
                [formControl]="stateSearchFormControl"
              >
              </app-states-select-search>
              <app-school-select-search
                *ngIf="column.name === 'School/Team'"
                [formControl]="schoolSearchFormControl"
              >
              </app-school-select-search>

              <div class="d-flex justify-content-center">
                <button
                  (click)="search(listOfFilter[i])"
                  class="search-button"
                  nz-button
                  nzSize="small"
                  nzType="primary"
                >
                  Search
                </button>
                <button
                  (click)="reset(listOfFilter[i])"
                  [nzTooltipColor]="'blue'"
                  [nzTooltipTitle]="'Clear Search'"
                  nz-button
                  nz-tooltip
                  nzSize="small"
                >
                  Reset
                </button>
              </div>
            </div>
          </div>
        </nz-dropdown-menu>
      </th>
      <th
        *ngIf="!(authService.currentUser$ | async).reel_eval_admin"
        [nzColumnKey]="listOfSort[7]"
        [nzSortFn]="true"
        nzRight
        nzWidth="130px"
      >
        Staff Score
      </th>
      <th
        [nzColumnKey]="listOfSort[8]"
        [nzSortFn]="true"
        nzRight
        nzWidth="100px"
      >
        IGA Score
      </th>
      <th
        *ngIf="
            (authService.currentUser$ | async).group !== permissions.ViewOnly &&
            (authService.currentUser$ | async).group !==
              permissions.GradeProspects
          "
        class="text-align-center ant-table-column-title"
        nzRight
        nzWidth="150px"
        style="color: white"
      >
        Action
      </th>
    </tr>
    </thead>
    <tbody>
    <tr
      *ngIf="showRow"
      [formGroup]="prospectForm"
      class="text-align-left background-primary"
    >
      <td></td>
      <td nzLeft>
          <span>
            <input formControlName="first_name" nz-input/>
          </span>
      </td>
      <td>
          <span>
            <input formControlName="last_name" nz-input/>
          </span>
      </td>
      <td>
          <span>
            <nz-select
              formControlName="position"
              nzMode="multiple"
              class="w-100"
              nzPlaceHolder="Select a position"
            >
              <nz-option
                *ngFor="let position of positions"
                [nzLabel]="position.position_name"
                [nzValue]="position.id"
              ></nz-option>
            </nz-select>
          </span>
      </td>
      <td>
          <span>
            <input formControlName="classification" nz-input/>
          </span>
      </td>
      <td>
          <span>
            <app-states-select-search
              formControlName="state"
            ></app-states-select-search>
          </span>
      </td>
      <td>
          <span>
            <app-school-select-search formControlName="school">
            </app-school-select-search>
          </span>
      </td>

      <td>
          <span>
            <input formControlName="video_link" nz-input/>
          </span>
      </td>
      <td
        *ngIf="!(authService.currentUser$ | async).reel_eval_admin"
        nzRight
      ></td>
      <td nzRight>
          <span *ngIf="(authService.currentUser$ | async).reel_eval_admin">
            <input
              class="ant-input ant-input-focused"
              formControlName="score"
              min="0"
              nz-col
              nz-input
              nzSize="small"
              step="1"
              type="number"
            />
          </span>
      </td>
      <td nzRight>
        <div class="d-flex justify-content-center">
            <span (click)="isSaveNew(false)" class="p-2">
              <i
                [nzTheme]="'twotone'"
                [nzTooltipColor]="'blue'"
                [nzTooltipTitle]="'Save Prospect'"
                [nzTwotoneColor]="'#46c40a'"
                nz-icon
                nz-tooltip
                nzType="save"
              ></i>
            </span>
          <span
            (nzOnCancel)="cancel()"
            (nzOnConfirm)="confirm()"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="'Discard changes'"
            class="p-2"
            nz-popconfirm
            nz-tooltip
            nzPopconfirmPlacement="top"
            nzPopconfirmTitle="Are you sure you want to discard changes?"
          >
              <i
                [nzTheme]="'twotone'"
                [nzTwotoneColor]="'#c00206'"
                nz-icon
                nzType="close-circle"
              ></i>
            </span>
          <span
            (click)="isSaveNew(true)"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="'Add New Prospect'"
            class="p-2"
            nz-tooltip
          >
              <i
                [nzTheme]="'twotone'"
                [nzTwotoneColor]="'#f5d50a'"
                nz-icon
                nzType="plus-circle"
              ></i>
            </span>
        </div>
      </td>
    </tr>
    <tr
      *ngFor="let data of borderedTable.data; let i = index"
      [class.background-primary]="currentEditIndex == i"
      [formGroup]="prospectForm"
      class="text-align-left"
    >
      <td
        (nzCheckedChange)="onItemChecked(data.id, $event)"
        *ngIf="
            (authService.currentUser$ | async).group !== permissions.ViewOnly
          "
        [nzChecked]="setOfCheckedId.has(data.id)"
        [nzShowCheckbox]="!(currentEditIndex === i)"
      ></td>
      <td nzEllipsis nzLeft>
          <span *ngIf="currentEditIndex != i">
            {{ data.first_name }}
          </span>
        <span *ngIf="currentEditIndex == i">
            <input
              [value]="data.first_name"
              formControlName="first_name"
              nz-input
            />
          </span>
      </td>
      <td nzEllipsis>
          <span *ngIf="currentEditIndex != i">
            {{ data.last_name }}
          </span>
        <span *ngIf="currentEditIndex == i">
            <input formControlName="last_name" nz-input/>
          </span>
      </td>
      <td class="posData" nzEllipsis>
          <span *ngIf="currentEditIndex != i">
            <span *ngFor="let position of data.pos; last as isLast"
            >{{ position.abbreviation.trim() }} {{ isLast ? "" : "/" }}</span
            >
          </span>
        <span *ngIf="currentEditIndex == i">
            <nz-select
              formControlName="position"
              nzMode="multiple"
              class="w-100"
              nzPlaceHolder="Select a position"
            >
              <nz-option
                *ngFor="let position of positions"
                [nzLabel]="position.position_name"
                [nzValue]="position.id"
              ></nz-option>
            </nz-select>
          </span>
      </td>
      <td nzEllipsis>
          <span *ngIf="currentEditIndex != i">
            {{ data.classification }}
          </span>
        <span *ngIf="currentEditIndex == i">
            <input formControlName="classification" nz-input/>
          </span>
      </td>
      <td nzEllipsis>
          <span *ngIf="currentEditIndex != i">
            {{ data.state }}
          </span>
        <span *ngIf="currentEditIndex == i">
            <app-states-select-search formControlName="state">
            </app-states-select-search>
          </span>
      </td>
      <td nzEllipsis>
          <span
            *ngIf="currentEditIndex != i"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="data.school"
            nz-tooltip
          >
            {{ data.school }}
          </span>
        <span *ngIf="currentEditIndex == i">
            <app-school-select-search formControlName="school">
            </app-school-select-search>
          </span>
      </td>

      <td nzEllipsis>
          <span *ngIf="currentEditIndex != i">
            <a
              *ngIf="data.video_link"
              [href]="data.video_link"
              nz-icon
              nzTheme="outline"
              nzType="video-camera"
              target="_blank"
            ></a>
          </span>
        <span *ngIf="currentEditIndex == i">
            <input formControlName="video_link" nz-input/>
          </span>
      </td>
      <td *ngIf="!(authService.currentUser$ | async).reel_eval_admin" nzRight>
          <span>
            <ng-container *ngFor="let score of data.prospect_score">
              <app-badge
                *ngIf="score.score"
                [text]="score.abbreviation + ' : ' + score.score"
              >
              </app-badge>
            </ng-container>
          </span>
      </td>
      <td nzRight>
          <span *ngIf="currentEditIndex != i">
            {{ data.iga_score ? data.iga_score : null }}
          </span>
        <span
          *ngIf="
              !(authService.currentUser$ | async).reel_eval_admin &&
              currentEditIndex == i
            "
        >
            {{ data.iga_score ? data.iga_score : null }}
          </span>
        <span
          *ngIf="
              (authService.currentUser$ | async).reel_eval_admin &&
              currentEditIndex == i
            "
        >
            <input
              class="ant-input ant-input-focused"
              formControlName="score"
              min="0"
              nz-col
              nz-input
              nzSize="small"
              step="1"
              type="number"
            />
          </span>
      </td>
      <td
        *ngIf="
            (authService.currentUser$ | async).group !== permissions.ViewOnly &&
            (authService.currentUser$ | async).group !==
              permissions.GradeProspects
          "
        nzRight
      >
        <div class="d-flex justify-content-center">
            <span
              (click)="isEdit(i)"
              *ngIf="currentEditIndex != i && !achievedTable"
              [nzTooltipColor]="'blue'"
              [nzTooltipTitle]="'Edit Prospect'"
              class="p-2"
              nz-tooltip
            >
              <i [nzTheme]="'twotone'" nz-icon nzType="edit"></i>
            </span>
          <span
            (click)="isSave(i)"
            *ngIf="currentEditIndex == i"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="'Save changes'"
            class="p-2"
            nz-tooltip
          >
              <i
                [nzTheme]="'twotone'"
                [nzTwotoneColor]="'#46c40a'"
                nz-icon
                nzType="save"
              ></i>
            </span>
          <span
            (nzOnCancel)="cancel()"
            (nzOnConfirm)="confirm()"
            *ngIf="currentEditIndex == i"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="'Discard changes'"
            class="p-2"
            nz-popconfirm
            nz-tooltip
            nzPopconfirmPlacement="top"
            nzPopconfirmTitle="Are you sure you want to discard changes?"
          >
              <i
                [nzTheme]="'twotone'"
                [nzTwotoneColor]="'#c00206'"
                nz-icon
                nzType="close-circle"
              ></i>
            </span>
          <span
            (nzOnCancel)="cancel()"
            (nzOnConfirm)="isDelete(i)"
            *ngIf="currentEditIndex != i"
            [nzTooltipColor]="'blue'"
            [nzTooltipTitle]="'Delete Prospect'"
            class="p-2"
            nz-popconfirm
            nz-tooltip
            nzPopconfirmPlacement="top"
            nzPopconfirmTitle="Are you sure you want to delete prospect?"
          >
              <i
                [nzTheme]="'twotone'"
                [nzTwotoneColor]="'#c00206'"
                nz-icon
                nzType="delete"
              ></i>
            </span>
          <ng-template [ngIf]="!achievedTable">
              <span
                (click)="isArchive(i)"
                *ngIf="currentEditIndex != i"
                [nzTooltipColor]="'blue'"
                [nzTooltipTitle]="'Archive Prospect'"
                class="p-2"
                nz-tooltip
              >
                <i nz-icon nzTheme="outline" nzType="export"></i>
              </span>
          </ng-template>
          <ng-template [ngIf]="achievedTable">
              <span
                (click)="isUnArchive(i)"
                *ngIf="currentEditIndex != i"
                [nzTooltipColor]="'blue'"
                [nzTooltipTitle]="'UnArchive Prospect'"
                class="p-2"
                nz-tooltip
              >
                <i nz-icon nzTheme="outline" nzType="export"></i>
              </span>
          </ng-template>
        </div>
      </td>
    </tr>
    </tbody>
  </nz-table>
</div>
